<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞–ø–µ—Ä—Å—Ç–∫–∏ - –ò–≥—Ä–∞</title>
    <style>
        /* ==================== CSS –°–¢–ò–õ–ò ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* –®–∞–ø–∫–∞ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .user-info button {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }

        .user-info button:hover {
            background: rgba(255,255,255,0.3);
        }

        /* –ò–≥—Ä–æ–≤–∞—è –∑–æ–Ω–∞ */
        .game-area {
            text-align: center;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        /* –°—Ç–∞–∫–∞–Ω—ã */
        .cups-container {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 40px 0;
        }

        .cup {
            font-size: 4em;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 20px;
            border-radius: 15px;
            background: rgba(255,255,255,0.1);
        }

        .cup:hover {
            transform: translateY(-10px);
            background: rgba(255,255,255,0.2);
        }

        .cup.selected {
            background: rgba(255,215,0,0.3);
            transform: scale(1.1);
        }

        /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∏–≥—Ä–µ */
        .game-info {
            margin: 20px 0;
        }

        .score {
            display: flex;
            justify-content: center;
            gap: 40px;
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .message {
            font-size: 1.3em;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .actions {
            margin: 20px 0;
        }

        .btn-primary {
            background: #4CAF50;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #ff6b6b;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            margin: 5px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            color: #333;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            text-align: center;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
        }

        .auth-tabs button {
            flex: 1;
            padding: 10px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
        }

        .auth-tabs .tab-active {
            background: #667eea;
            color: white;
        }

        .auth-tab input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏ */
        .special-mechanics {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .mechanic-option {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 15px 25px;
            margin: 10px;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-size: 1.1em;
            transition: background 0.3s;
        }

        .mechanic-option:hover {
            background: rgba(255,255,255,0.3);
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 600px) {
            .cups-container {
                gap: 15px;
            }

            .cup {
                font-size: 3em;
                padding: 15px;
            }

            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- –®–∞–ø–∫–∞ -->
    <header class="header">
        <h1>üéØ –ù–∞–ø–µ—Ä—Å—Ç–∫–∏</h1>
        <div class="user-info" id="userInfo">
            <button onclick="showAuthModal()">–í–æ–π—Ç–∏</button>
        </div>
    </header>

    <!-- –ò–≥—Ä–æ–≤–∞—è –∑–æ–Ω–∞ -->
    <main class="game-area">
        <!-- –°—Ç–∞–∫–∞–Ω—ã -->
        <div class="cups-container" id="cupsContainer">
            <div class="cup" onclick="makeGuess(0)">ü•§ 1</div>
            <div class="cup" onclick="makeGuess(1)">ü•§ 2</div>
            <div class="cup" onclick="makeGuess(2)">ü•§ 3</div>
        </div>

        <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã -->
        <div class="game-info">
            <div class="score">
                <span>–ò–≥—Ä–æ–∫: <span id="playerScore">0</span></span>
                <span>–î–∏–ª–µ—Ä: <span id="dealerScore">0</span></span>
            </div>
            <div class="message" id="gameMessage">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ù–∞–ø–µ—Ä—Å—Ç–∫–∏! –í–æ–π–¥–∏—Ç–µ –∏ –Ω–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É.</div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="actions" id="actions">
            <button onclick="startNewGame()" class="btn-primary">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
        </div>

        <!-- –ó–æ–Ω–∞ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∫ -->
        <div class="special-mechanics" id="specialMechanics" style="display: none;"></div>
    </main>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
<div id="authModal" class="modal">
    <div class="modal-content">
        <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
        <div class="auth-tabs">
            <button onclick="showTab('login')" class="tab-active">–í—Ö–æ–¥</button>
            <button onclick="showTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>

        <div id="loginTab" class="auth-tab">
            <input type="text" id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="login()" class="btn-primary">–í–æ–π—Ç–∏</button>
        </div>

        <div id="registerTab" class="auth-tab" style="display: none;">
            <input type="text" id="regUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <input type="text" id="regNickname" placeholder="–ù–∏–∫–Ω–µ–π–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
            <button onclick="register()" class="btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </div>
    </div>
</div>

<script>
    // ==================== JAVASCRIPT –ö–û–î ====================
    console.log('üéØ –ù–∞–ø–µ—Ä—Å—Ç–∫–∏ - –∏–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è!');

    const API_BASE_URL = 'http://localhost:8081';
    let currentGameId = null;
    let jwtToken = null;
    let currentUser = null;

    // ==================== –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ====================
    function showAuthModal() {
        console.log('üîì –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
        document.getElementById('authModal').style.display = 'block';
    }

    function hideAuthModal() {
        document.getElementById('authModal').style.display = 'none';
    }

    function showTab(tabName) {
        console.log('üìë –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É:', tabName);
        // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Ç–∞–±—ã
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.style.display = 'none';
        });

        // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å
        document.querySelectorAll('.auth-tabs button').forEach(btn => {
            btn.classList.remove('tab-active');
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–±
        document.getElementById(tabName + 'Tab').style.display = 'block';
        event.target.classList.add('tab-active');
    }

    async function login() {
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        if (!username || !password) {
            showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!', 'error');
            return;
        }

        console.log('üîê –ü—ã—Ç–∞–µ–º—Å—è –≤–æ–π—Ç–∏:', username);

        try {
            const response = await fetch(`${API_BASE_URL}/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password })
            });

            console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status);

            if (response.ok) {
                const data = await response.json();
                jwtToken = data.token;
                currentUser = username;
                console.log('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥! –¢–æ–∫–µ–Ω:', jwtToken);
                updateUserInfo();
                hideAuthModal();
                showMessage('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥! –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É.', 'success');
            } else {
                const error = await response.text();
                console.log('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                showMessage(error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', 'error');
            }
        } catch (error) {
            console.error('üí• –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
            showMessage('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        }
    }

    async function register() {
        const username = document.getElementById('regUsername').value;
        const password = document.getElementById('regPassword').value;
        const nickname = document.getElementById('regNickname').value || username;

        if (!username || !password) {
            showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å!', 'error');
            return;
        }

        console.log('üìù –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', username);

        try {
            const response = await fetch(`${API_BASE_URL}/auth/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password, nickname })
            });

            console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status);

            if (response.ok) {
                console.log('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
                showMessage('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.', 'success');
                // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
                document.getElementById('regUsername').value = '';
                document.getElementById('regPassword').value = '';
                document.getElementById('regNickname').value = '';
                showTab('login');
            } else {
                const error = await response.text();
                console.log('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
                showMessage(error, 'error');
            }
        } catch (error) {
            console.error('üí• –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
            showMessage('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        }
    }

    function updateUserInfo() {
        const userInfo = document.getElementById('userInfo');
        if (currentUser) {
            userInfo.innerHTML = `
                <span>–ü—Ä–∏–≤–µ—Ç, ${currentUser}!</span>
                <button onclick="logout()" style="margin-left: 10px;">–í—ã–π—Ç–∏</button>
            `;
        } else {
            userInfo.innerHTML = '<button onclick="showAuthModal()">–í–æ–π—Ç–∏</button>';
        }
    }

    function logout() {
        console.log('üö™ –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
        jwtToken = null;
        currentUser = null;
        currentGameId = null;
        updateUserInfo();
        resetGameUI();
        showMessage('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'info');
    }

    // ==================== –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ====================
    async function startNewGame() {
        console.log('üéÆ –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É');

        if (!jwtToken) {
            showMessage('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É!', 'error');
            return;
        }

        currentGameId = 'game_' + Date.now();
        console.log('üÜî ID –∏–≥—Ä—ã:', currentGameId);

        try {
            const response = await fetch(`${API_BASE_URL}/api/game/start?gameId=${currentGameId}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${jwtToken}`
                }
            });

            console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status);

            if (response.ok) {
                const gameState = await response.json();
                console.log('‚úÖ –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å:', gameState);
                updateGameUI(gameState);
                showMessage('–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–∫–∞–Ω.', 'info');
                enableCups();
            } else {
                showMessage('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã', 'error');
            }
        } catch (error) {
            console.error('üí• –û—à–∏–±–∫–∞:', error);
            showMessage('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        }
    }

    async function makeGuess(cupIndex) {
        console.log('üéØ –í—ã–±—Ä–∞–Ω —Å—Ç–∞–∫–∞–Ω:', cupIndex + 1);

        if (!currentGameId || !jwtToken) {
            showMessage('–°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É!', 'error');
            return;
        }

        highlightCup(cupIndex);
        disableCups();
        showMessage('–ü—Ä–æ–≤–µ—Ä—è–µ–º...', 'info');

        try {
            const response = await fetch(
                `${API_BASE_URL}/api/game/guess?gameId=${currentGameId}&guessedPosition=${cupIndex}`,
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`
                    }
                }
            );

            console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status);

            if (response.ok) {
                const guessResult = await response.json();
                console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç:', guessResult);
                processGuessResult(guessResult);
            } else {
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–≥–∞–¥—ã–≤–∞–Ω–∏–∏', 'error');
                enableCups();
            }
        } catch (error) {
            console.error('üí• –û—à–∏–±–∫–∞:', error);
            showMessage('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
            enableCups();
        }
    }

    function processGuessResult(result) {
        updateScores(result.playerScore, result.dealerScore);

        if (result.gameFinished) {
            showGameFinished(result);
            return;
        }

        if (result.correct && !result.dealerCheated) {
            showMessage(result.message, 'success');
            showBallPosition(result.actualBallPosition);
            setTimeout(() => resetForNewRound(), 3000);
        }
        else if (result.dealerCheated) {
            showMessage(result.message, 'warning');
            // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ—Ö–∞–Ω–∏–∫
            setTimeout(() => resetForNewRound(), 3000);
        }
        else {
            showMessage(result.message, 'error');
            showBallPosition(result.actualBallPosition);
            setTimeout(() => resetForNewRound(), 3000);
        }
    }

    // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
    function highlightCup(index) {
        document.querySelectorAll('.cup').forEach((cup, i) => {
            cup.classList.toggle('selected', i === index);
        });
    }

    function showBallPosition(position) {
        document.querySelectorAll('.cup').forEach((cup, i) => {
            if (i === position) {
                cup.textContent = 'üéØ';
                cup.style.background = 'rgba(255,215,0,0.3)';
            }
        });
    }

    function enableCups() {
        document.querySelectorAll('.cup').forEach(cup => {
            cup.style.pointerEvents = 'auto';
            cup.style.opacity = '1';
        });
    }

    function disableCups() {
        document.querySelectorAll('.cup').forEach(cup => {
            cup.style.pointerEvents = 'none';
            cup.style.opacity = '0.7';
        });
    }

    function resetCups() {
        document.querySelectorAll('.cup').forEach((cup, i) => {
            cup.textContent = `ü•§ ${i + 1}`;
            cup.classList.remove('selected');
            cup.style.background = 'rgba(255,255,255,0.1)';
        });
    }

    function updateScores(player, dealer) {
        document.getElementById('playerScore').textContent = player;
        document.getElementById('dealerScore').textContent = dealer;
    }

    function showMessage(message, type = 'info') {
        const gameMessage = document.getElementById('gameMessage');
        gameMessage.textContent = message;

        const colors = {
            success: 'rgba(76, 175, 80, 0.3)',
            error: 'rgba(244, 67, 54, 0.3)',
            warning: 'rgba(255, 152, 0, 0.3)',
            info: 'rgba(0, 0, 0, 0.2)'
        };

        gameMessage.style.background = colors[type] || colors.info;
    }

    function resetGameUI() {
        resetCups();
        document.getElementById('specialMechanics').style.display = 'none';
        updateScores(0, 0);
        showMessage('–ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é –∏–≥—Ä—É!', 'info');
        enableCups();
    }

    function resetForNewRound() {
        resetCups();
        document.getElementById('specialMechanics').style.display = 'none';
        showMessage('–ù–æ–≤—ã–π —Ä–∞—É–Ω–¥! –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–∫–∞–Ω.', 'info');
        enableCups();
    }

    function showGameFinished(result) {
        disableCups();
        if (result.playerScore > result.dealerScore) {
            showMessage('üéâ –ü–û–ë–ï–î–ê! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –∏–≥—Ä—É!', 'success');
        } else {
            showMessage('üòî –ü–æ—Ä–∞–∂–µ–Ω–∏–µ! –î–∏–ª–µ—Ä –≤—ã–∏–≥—Ä–∞–ª –∏–≥—Ä—É.', 'error');
        }
    }

    function updateGameUI(gameState) {
        updateScores(gameState.playerScore, gameState.dealerScore);
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    window.onclick = function(event) {
        const modal = document.getElementById('authModal');
        if (event.target === modal) {
            hideAuthModal();
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–≥—Ä–∞ –≥–æ—Ç–æ–≤–∞!');
        updateUserInfo();
    });
</script>
</body>
</html>