<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞–ø–µ—Ä—Å—Ç–∫–∏ - –ò–≥—Ä–∞</title>
    <style>
        /* ==================== CSS –°–¢–ò–õ–ò ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen {
            display: none;
            text-align: center;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 40px;
            backdrop-filter: blur(10px);
        }

        .screen.active {
            display: block;
        }

        /* –®–∞–ø–∫–∞ */
        .header {
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* –°—Ç–∞–∫–∞–Ω—ã */
        .cups-container {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 40px 0;
            position: relative;
            min-height: 180px;
        }

        .cup {
            font-size: 4em;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 20px;
            border-radius: 15px;
            background: rgba(255,255,255,0.1);
            position: relative;
            z-index: 1;
            min-width: 120px;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cup:hover {
            transform: translateY(-10px);
            background: rgba(255,255,255,0.2);
        }

        .cup.selected {
            background: rgba(255,215,0,0.3);
            transform: scale(1.1);
        }

        .cup.shuffling {
            animation: shuffleAnimation 0.8s ease-in-out;
        }

        .cup.ball-placed {
            animation: ballDrop 0.8s ease-in-out;
        }

        .cup.swapping {
            animation: swapAnimation 1s ease-in-out;
        }

        .cup.hiding {
            animation: hideAnimation 1s ease-in-out;
        }

        .cup.moving-left {
            animation: moveLeftRight 1s ease-in-out infinite alternate;
        }

        .cup.moving-right {
            animation: moveRightLeft 1s ease-in-out infinite alternate;
        }

        .cup.circle-move {
            animation: circleMove 2s ease-in-out;
        }

        .ball-indicator {
            position: absolute;
            top: -15px;
            right: -15px;
            background: gold;
            color: black;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6em;
            font-weight: bold;
            z-index: 2;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .cup.has-ball .ball-indicator {
            opacity: 1;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes ballDrop {
            0% {
                transform: translateY(-100px) rotateX(90deg);
                opacity: 0;
            }
            50% {
                transform: translateY(20px) rotateX(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(0) rotateX(0deg);
            }
        }

        @keyframes shuffleAnimation {
            0% { transform: translateX(0) translateY(0); }
            25% { transform: translateX(80px) translateY(-40px); }
            50% { transform: translateX(-60px) translateY(30px); }
            75% { transform: translateX(40px) translateY(-20px); }
            100% { transform: translateX(0) translateY(0); }
        }

        @keyframes swapAnimation {
            0% { transform: translateX(0); }
            25% { transform: translateX(120px) scale(0.9); }
            50% { transform: translateX(180px) scale(0.8); }
            75% { transform: translateX(120px) scale(0.9); }
            100% { transform: translateX(0) scale(1); }
        }

        @keyframes hideAnimation {
            0% { transform: scale(1); }
            50% { transform: scale(0.8) rotate(-10deg); }
            100% { transform: scale(1); }
        }

        @keyframes moveLeftRight {
            0% { transform: translateX(-80px); }
            100% { transform: translateX(80px); }
        }

        @keyframes moveRightLeft {
            0% { transform: translateX(80px); }
            100% { transform: translateX(-80px); }
        }

        @keyframes circleMove {
            0% { transform: translate(0, 0); }
            25% { transform: translate(100px, -50px); }
            50% { transform: translate(0, -100px); }
            75% { transform: translate(-100px, -50px); }
            100% { transform: translate(0, 0); }
        }

        @keyframes fastShuffle {
            0% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(100px) rotate(90deg); }
            50% { transform: translateX(-100px) rotate(180deg); }
            75% { transform: translateX(100px) rotate(270deg); }
            100% { transform: translateX(0) rotate(360deg); }
        }

        /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∏–≥—Ä–µ */
        .game-info {
            margin: 20px 0;
        }

        .score {
            display: flex;
            justify-content: center;
            gap: 30px;
            font-size: 1.2em;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .score span {
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 10px;
        }

        .message {
            font-size: 1.3em;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .actions {
            margin: 30px 0;
        }

        .btn-primary {
            background: #4CAF50;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            color: white;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
            min-width: 200px;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #ff6b6b;
            border: none;
            padding: 12px 30px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            margin: 10px;
            font-size: 1.1em;
        }

        .btn-warning {
            background: #ff9800;
            border: none;
            padding: 12px 30px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            margin: 10px;
            font-size: 1.1em;
        }

        .btn-role {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 20px 30px;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            margin: 15px;
            font-size: 1.2em;
            transition: all 0.3s;
            min-width: 180px;
        }

        .btn-role:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-5px);
        }

        /* –§–æ—Ä–º—ã */
        .auth-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .auth-form input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            background: rgba(255,255,255,0.9);
        }

        /* –†–æ–ª–∏ */
        .roles-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 40px 0;
            flex-wrap: wrap;
        }

        .role-card {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            min-width: 200px;
            transition: all 0.3s;
        }

        .role-card:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-5px);
        }

        .role-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã */
        .result-message {
            font-size: 2em;
            margin: 30px 0;
            padding: 20px;
            border-radius: 15px;
            background: rgba(255,255,255,0.1);
        }

        .stats {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            font-size: 1.1em;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è - –æ–≤–µ—Ä–ª–µ–π */
        .animation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 2em;
            color: white;
            flex-direction: column;
        }

        .animation-overlay.active {
            display: flex;
        }

        .countdown {
            font-size: 5em;
            margin-bottom: 30px;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
        }

        .animation-text {
            font-size: 1.8em;
            text-align: center;
            margin-top: 20px;
            color: #fff;
        }

        /* –í—ã–±–æ—Ä –∂—É–ª—å–Ω–∏—á–µ—Å—Ç–≤–∞ */
        .cheat-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .cheat-option {
            background: rgba(255,193,7,0.3);
            border: none;
            padding: 20px;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s;
            min-width: 150px;
        }

        .cheat-option:hover {
            background: rgba(255,193,7,0.5);
            transform: translateY(-5px);
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 600px) {
            .cups-container {
                gap: 15px;
            }

            .cup {
                font-size: 3em;
                padding: 15px;
                min-width: 90px;
            }

            .header h1 {
                font-size: 2em;
            }

            .score {
                gap: 10px;
            }

            .roles-container {
                flex-direction: column;
                align-items: center;
            }

            .btn-primary {
                padding: 12px 30px;
                font-size: 1.1em;
                min-width: 150px;
            }

            .cheat-options {
                flex-direction: column;
                align-items: center;
            }

            .countdown {
                font-size: 3.5em;
            }

            .animation-text {
                font-size: 1.4em;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- –≠–∫—Ä–∞–Ω 1: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
    <div class="screen active" id="welcomeScreen">
        <div class="header">
            <h1>üéØ –ù–∞–ø–µ—Ä—Å—Ç–∫–∏</h1>
            <div class="subtitle">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∏–≥—Ä–∞ –Ω–∞ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —É–¥–∞—á—É!</div>
        </div>
        <div class="actions">
            <button class="btn-primary" onclick="showScreen('authScreen')">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω 2: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <div class="screen" id="authScreen">
        <div class="header">
            <h1>üîê –í—Ö–æ–¥ –≤ –∏–≥—Ä—É</h1>
            <div class="subtitle">–í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</div>
        </div>

        <div class="auth-form">
            <div id="loginForm">
                <input type="text" id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                <button class="btn-primary" onclick="login()">–í–æ–π—Ç–∏</button>
                <button class="btn-secondary" onclick="switchToRegister()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>

            <div id="registerForm" style="display: none;">
                <input type="text" id="regUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                <input type="text" id="regNickname" placeholder="–ù–∏–∫–Ω–µ–π–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                <button class="btn-primary" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <button class="btn-secondary" onclick="switchToLogin()">–ù–∞–∑–∞–¥ –∫ –≤—Ö–æ–¥—É</button>
            </div>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω 3: –í—ã–±–æ—Ä —Ä–æ–ª–∏ -->
    <div class="screen" id="roleScreen">
        <div class="header">
            <h1>üé≠ –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</h1>
            <div class="subtitle">–ö—Ç–æ –≤—ã –≤ —ç—Ç–æ–π –∏–≥—Ä–µ?</div>
        </div>

        <div class="roles-container">
            <div class="role-card">
                <div class="role-icon">üéØ</div>
                <h3>–ò–≥—Ä–æ–∫</h3>
                <p>–£–≥–∞–¥—ã–≤–∞–π—Ç–µ –≥–¥–µ —à–∞—Ä–∏–∫ –∏ —Ä–∞–∑–æ–±–ª–∞—á–∞–π—Ç–µ –∂—É–ª—å–Ω–∏—á–µ—Å—Ç–≤–æ</p>
                <button class="btn-role" onclick="selectRole('player')">–ò–≥—Ä–∞—Ç—å –∫–∞–∫ –∏–≥—Ä–æ–∫</button>
            </div>

            <div class="role-card">
                <div class="role-icon">üé©</div>
                <h3>–î–∏–ª–µ—Ä</h3>
                <p>–ü—Ä—è—á—å—Ç–µ —à–∞—Ä–∏–∫ –∏ –∑–∞–ø—É—Ç—ã–≤–∞–π—Ç–µ –∏–≥—Ä–æ–∫–∞</p>
                <button class="btn-role" onclick="selectRole('dealer')">–ò–≥—Ä–∞—Ç—å –∫–∞–∫ –¥–∏–ª–µ—Ä</button>
            </div>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω 4: –ò–≥—Ä–æ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å (–ò–≥—Ä–æ–∫) -->
    <div class="screen" id="playerGameScreen">
        <div class="header">
            <h1>üéØ –£–≥–∞–¥–∞–π—Ç–µ –≥–¥–µ —à–∞—Ä–∏–∫!</h1>
            <div class="user-info" id="playerUserInfo"></div>
        </div>

        <!-- –°—Ç–∞–∫–∞–Ω—ã (–±–µ–∑ –Ω–æ–º–µ—Ä–æ–≤ –¥–ª—è –∏–≥—Ä–æ–∫–∞) -->
        <div class="cups-container" id="playerCupsContainer">
            <div class="cup" onclick="playerMakeGuess(0)">
                ü•§
                <div class="ball-indicator">‚ö™</div>
            </div>
            <div class="cup" onclick="playerMakeGuess(1)">
                ü•§
                <div class="ball-indicator">‚ö™</div>
            </div>
            <div class="cup" onclick="playerMakeGuess(2)">
                ü•§
                <div class="ball-indicator">‚ö™</div>
            </div>
        </div>

        <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã -->
        <div class="game-info">
            <div class="score">
                <span>–ò–≥—Ä–æ–∫: <span id="playerScore">0</span>/3</span>
                <span>–î–∏–ª–µ—Ä: <span id="dealerScore">0</span>/3</span>
                <span>–†–∞—É–Ω–¥: <span id="playerRoundNumber">1</span>/5</span>
            </div>
            <div class="message" id="playerGameMessage">–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ —Ä–∞—É–Ω–¥–∞...</div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="actions">
            <button class="btn-secondary" onclick="showScreen('resultsScreen')">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É</button>
        </div>

        <!-- –ó–æ–Ω–∞ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∫ -->
        <div class="special-mechanics" id="playerSpecialMechanics" style="display: none;"></div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω 4: –ò–≥—Ä–æ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å (–î–∏–ª–µ—Ä) -->
    <div class="screen" id="dealerGameScreen">
        <div class="header">
            <h1>üé© –í—ã - –î–∏–ª–µ—Ä!</h1>
            <div class="user-info" id="dealerUserInfo"></div>
        </div>

        <!-- –í—ã–±–æ—Ä —Å—Ç–∞–∫–∞–Ω–∞ –¥–ª—è –¥–∏–ª–µ—Ä–∞ -->
        <div class="game-info" id="dealerPlacementStage">
            <div class="message">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–∫–∞–Ω –∫—É–¥–∞ –ø–æ–ª–æ–∂–∏—Ç—å —à–∞—Ä–∏–∫:</div>
            <div class="cups-container">
                <div class="cup" onclick="dealerPlaceBall(0)">
                    ü•§ 1
                    <div class="ball-indicator">‚ö™</div>
                </div>
                <div class="cup" onclick="dealerPlaceBall(1)">
                    ü•§ 2
                    <div class="ball-indicator">‚ö™</div>
                </div>
                <div class="cup" onclick="dealerPlaceBall(2)">
                    ü•§ 3
                    <div class="ball-indicator">‚ö™</div>
                </div>
            </div>
        </div>

        <!-- –û–∂–∏–¥–∞–Ω–∏–µ —Ö–æ–¥–∞ –∏–≥—Ä–æ–∫–∞ -->
        <div class="game-info" id="dealerWaitStage" style="display: none;">
            <div class="message" id="dealerWaitMessage">–ò–≥—Ä–æ–∫ —É–≥–∞–¥—ã–≤–∞–µ—Ç –≥–¥–µ —à–∞—Ä–∏–∫...</div>
            <div class="cups-container" id="dealerWaitCups">
                <div class="cup">ü•§</div>
                <div class="cup">ü•§</div>
                <div class="cup">ü•§</div>
            </div>
        </div>

        <!-- –í—ã–±–æ—Ä –∂—É–ª—å–Ω–∏—á–µ—Å—Ç–≤–∞ -->
        <div class="game-info" id="dealerCheatStage" style="display: none;">
            <div class="message">–ò–≥—Ä–æ–∫ —É–≥–∞–¥–∞–ª! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:</div>
            <div class="cheat-options">
                <button class="cheat-option" onclick="dealerCheat('hide')">üé© –°–ø—Ä—è—Ç–∞—Ç—å –≤ —Ä—É–∫–∞–≤</button>
                <button class="cheat-option" onclick="dealerCheat('swap')">üîÑ –ü–µ—Ä–µ–ª–æ–∂–∏—Ç—å —à–∞—Ä–∏–∫</button>
                <button class="cheat-option" onclick="dealerCheat('add')">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–∫–∞–Ω</button>
                <button class="btn-secondary" onclick="dealerAcceptLoss()">–ü—Ä–∏–Ω—è—Ç—å –ø–æ—Ä–∞–∂–µ–Ω–∏–µ</button>
            </div>
        </div>

        <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã -->
        <div class="game-info">
            <div class="score">
                <span>–ò–≥—Ä–æ–∫: <span id="dealerViewPlayerScore">0</span>/3</span>
                <span>–î–∏–ª–µ—Ä: <span id="dealerViewDealerScore">0</span>/3</span>
                <span>–†–∞—É–Ω–¥: <span id="dealerRoundNumber">1</span>/5</span>
            </div>
        </div>

        <div class="actions">
            <button class="btn-secondary" onclick="showScreen('resultsScreen')">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É</button>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω 5: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div class="screen" id="resultsScreen">
        <div class="header">
            <h1>üèÜ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã</h1>
        </div>

        <div class="result-message" id="finalResult"></div>

        <div class="stats" id="gameStats">
            <div id="statsContent"></div>
        </div>

        <div class="actions">
            <button class="btn-primary" onclick="startNewGame()">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
            <button class="btn-secondary" onclick="showScreen('welcomeScreen')">–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
        </div>
    </div>
</div>

<!-- –û–≤–µ—Ä–ª–µ–π –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π -->
<div class="animation-overlay" id="animationOverlay">
    <div class="animation-text" id="animationText">üé© –î–∏–ª–µ—Ä –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–µ—Ç —Å—Ç–∞–∫–∞–Ω—ã...</div>
</div>

<script>
    // ==================== JAVASCRIPT –ö–û–î ====================
    const API_BASE_URL = 'http://localhost:8081';
    let currentGameId = null;
    let jwtToken = null;
    let currentUser = null;
    let selectedRole = 'player';
    let currentBallPosition = null;
    let swapInProgress = false; // –§–ª–∞–≥, —á—Ç–æ —Å–µ–π—á–∞—Å –∏–¥–µ—Ç swap
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ª–æ–≥–∏–∫–∏
    let playerGuessPosition = null;
    let currentBallPositionBeforeCheat = null;

    // ==================== –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ò ====================
    let currentRound = 1;
    const maxRounds = 5;
    const winsToWinGame = 3;
    let playerWins = 0;
    let dealerWins = 0;
    let gameFinished = false;
    let gameHistory = [];

    // ==================== –ê–ù–ò–ú–ê–¶–ò–ò ====================
    function showShuffleAnimation() {
        const overlay = document.getElementById('animationOverlay');
        const animationText = document.getElementById('animationText');

        overlay.classList.add('active');
        animationText.textContent = 'üé© –î–∏–ª–µ—Ä –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–µ—Ç —Å—Ç–∞–∫–∞–Ω—ã...';

        // –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç - —Å—Ä–∞–∑—É –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Å—Ç–∞–∫–∞–Ω–æ–≤
        animateCupsShuffle();

        // –°–∫—Ä—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            overlay.classList.remove('active');
        }, 3000);
    }

    function animateCupsShuffle() {
        const cups = document.querySelectorAll('.cup');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —à–∞—Ä–∏–∫ –≤ –Ω–∞—á–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
        cups.forEach((cup, index) => {
            cup.classList.remove('has-ball');
            if (index === currentBallPosition) {
                cup.classList.add('has-ball');
            }
        });

        // –†–∞–∑–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∞–∫–∞–Ω–æ–≤ –¥–ª—è –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
        cups.forEach((cup, index) => {
            setTimeout(() => {
                // –†–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –∞–Ω–∏–º–∞—Ü–∏–π –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
                if (index === 0) {
                    cup.classList.add('shuffling');
                } else if (index === 1) {
                    cup.classList.add('moving-left');
                } else if (index === 2) {
                    cup.classList.add('moving-right');
                }

                // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å—ã –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∏—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                setTimeout(() => {
                    cup.classList.remove('shuffling', 'moving-left', 'moving-right');
                    cup.classList.remove('has-ball');
                }, 2000);
            }, index * 100);
        });
    }

    function animateBallPlacement(position) {
        const cups = document.querySelectorAll('.cup');
        const cup = cups[position];

        cup.classList.add('ball-placed');
        cup.classList.add('has-ball');

        // –£–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—Å–ª–µ –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        setTimeout(() => {
            cup.classList.remove('ball-placed');
        }, 800);
    }

    function animateSwapBall(oldPosition, newPosition) {
        const cups = document.querySelectorAll('.cup');

        if (oldPosition >= 0 && oldPosition < cups.length) {
            // –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ —Å—Ç–∞–∫–∞–Ω–∞ (—à–∞—Ä–∏–∫ "—É—Ö–æ–¥–∏—Ç")
            const oldCup = cups[oldPosition];
            oldCup.classList.add('swapping');
            oldCup.classList.add('has-ball');

            setTimeout(() => {
                oldCup.classList.remove('has-ball');
                oldCup.classList.remove('swapping');

                // –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —Å—Ç–∞–∫–∞–Ω–∞ (—à–∞—Ä–∏–∫ "–ø—Ä–∏—Ö–æ–¥–∏—Ç")
                if (newPosition >= 0 && newPosition < cups.length) {
                    const newCup = cups[newPosition];
                    newCup.classList.add('ball-placed');
                    newCup.classList.add('has-ball');

                    setTimeout(() => {
                        newCup.classList.remove('ball-placed');
                        setTimeout(() => {
                            newCup.classList.remove('has-ball');
                        }, 1000);
                    }, 800);
                }
            }, 1000);
        }
    }

    function animateHideBall(position) {
        const cups = document.querySelectorAll('.cup');
        if (position >= 0 && position < cups.length) {
            const cup = cups[position];
            cup.classList.add('hiding');
            cup.classList.add('has-ball');

            setTimeout(() => {
                cup.classList.remove('has-ball');
                cup.classList.remove('hiding');
            }, 1000);
        }
    }

    // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –≠–ö–†–ê–ù–ê–ú–ò ====================
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(screenId).classList.add('active');
    }

    function switchToRegister() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
    }

    function switchToLogin() {
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('loginForm').style.display = 'block';
    }

    function selectRole(role) {
        selectedRole = role;
        if (role === 'player') {
            showScreen('playerGameScreen');
            initializePlayerGame();
        } else {
            showScreen('dealerGameScreen');
            initializeDealerGame();
        }
        updateUserInfo();
    }

    // ==================== –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ====================
    async function login() {
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        if (!username || !password) {
            showPlayerMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!', 'error');
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password })
            });

            if (response.ok) {
                const data = await response.json();
                jwtToken = data.token;
                currentUser = username;
                updateUserInfo();
                showScreen('roleScreen');
                showPlayerMessage('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!', 'success');
            } else {
                const error = await response.text();
                showPlayerMessage(error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', 'error');
            }
        } catch (error) {
            showPlayerMessage('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        }
    }

    async function register() {
        const username = document.getElementById('regUsername').value;
        const password = document.getElementById('regPassword').value;
        const nickname = document.getElementById('regNickname').value || username;

        if (!username || !password) {
            showPlayerMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å!', 'error');
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/auth/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password, nickname })
            });

            if (response.ok) {
                showPlayerMessage('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.', 'success');
                switchToLogin();
                document.getElementById('regUsername').value = '';
                document.getElementById('regPassword').value = '';
                document.getElementById('regNickname').value = '';
            } else {
                const error = await response.text();
                showPlayerMessage(error, 'error');
            }
        } catch (error) {
            showPlayerMessage('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        }
    }

    function updateUserInfo() {
        const playerInfo = document.getElementById('playerUserInfo');
        const dealerInfo = document.getElementById('dealerUserInfo');

        if (currentUser) {
            const infoText = `–ò–≥—Ä–æ–∫: ${currentUser} | –†–æ–ª—å: ${selectedRole === 'player' ? 'üéØ –ò–≥—Ä–æ–∫' : 'üé© –î–∏–ª–µ—Ä'}`;
            if (playerInfo) playerInfo.innerHTML = infoText;
            if (dealerInfo) dealerInfo.innerHTML = infoText;
        }
    }

    // ==================== –õ–û–ì–ò–ö–ê –ò–ì–†–û–ö–ê ====================
    function initializePlayerGame() {
        resetGame();
        showPlayerMessage('–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ —Ä–∞—É–Ω–¥–∞...', 'info');
        disablePlayerCups();
    }

    function playerMakeGuess(cupIndex) {
        if (!currentGameId) {
            showPlayerMessage('–†–∞—É–Ω–¥ –µ—â–µ –Ω–µ –Ω–∞—á–∞—Ç!', 'error');
            return;
        }

        highlightPlayerCup(cupIndex);
        disablePlayerCups();
        showPlayerMessage('–î–∏–ª–µ—Ä –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–µ—Ç —Å—Ç–∞–∫–∞–Ω—ã...', 'info');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è
        showShuffleAnimation();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => {
            const isCorrect = (cupIndex === currentBallPosition);
            processPlayerGuessResult(isCorrect, cupIndex);
        }, 3000); // –£–º–µ–Ω—å—à–∏–ª –≤—Ä–µ–º—è –¥–æ 3 —Å–µ–∫—É–Ω–¥
    }

    function processPlayerGuessResult(isCorrect, guessedPosition) {
        if (isCorrect) {
            showPlayerMessage('üéâ –ü—Ä–∞–≤–∏–ª—å–Ω–æ! –í—ã —É–≥–∞–¥–∞–ª–∏!', 'success');
            playerWins++;
            showPlayerMessage('–î–∏–ª–µ—Ä —Ä–µ—à–∞–µ—Ç —á—Ç–æ –¥–µ–ª–∞—Ç—å...', 'info');

            setTimeout(() => {
                showPlayerMessage('–î–∏–ª–µ—Ä —Å–∂—É–ª—å–Ω–∏—á–∞–ª! –í—ã –º–æ–∂–µ—Ç–µ –µ–≥–æ –æ–±–≤–∏–Ω–∏—Ç—å.', 'warning');
                showPlayerAccusationOptions();
            }, 2000);

        } else {
            showPlayerMessage('‚ùå –ù–µ —É–≥–∞–¥–∞–ª–∏! –®–∞—Ä–∏–∫ –±—ã–ª –≤ –¥—Ä—É–≥–æ–º —Å—Ç–∞–∫–∞–Ω–µ.', 'error');
            dealerWins++;
            showBallPosition(guessedPosition, false);
        }

        updateScores();

        const roundResult = {
            round: currentRound,
            playerGuess: guessedPosition,
            actualPosition: currentBallPosition,
            correct: isCorrect,
            dealerCheated: isCorrect
        };
        gameHistory.push(roundResult);

        currentRound++;
        updateRoundInfo();

        if (checkGameOver()) {
            showFinalResults();
        }
    }

    function showPlayerAccusationOptions() {
        const specialMechanics = document.getElementById('playerSpecialMechanics');
        specialMechanics.innerHTML = `
            <h3>üé© –î–∏–ª–µ—Ä –∂—É–ª—å–Ω–∏—á–∞–µ—Ç!</h3>
            <p>–û–±–≤–∏–Ω–∏—Ç–µ –¥–∏–ª–µ—Ä–∞ –≤ –∂—É–ª—å–Ω–∏—á–µ—Å—Ç–≤–µ:</p>
            <div class="cheat-options">
                <button class="cheat-option" onclick="playerAccuse('hide')">üé© –°–ø—Ä—è—Ç–∞–ª –≤ —Ä—É–∫–∞–≤</button>
                <button class="cheat-option" onclick="playerAccuse('swap')">üîÑ –ü–µ—Ä–µ–ª–æ–∂–∏–ª —à–∞—Ä–∏–∫</button>
                <button class="cheat-option" onclick="playerAccuse('add')">‚ûï –î–æ–±–∞–≤–∏–ª —Å—Ç–∞–∫–∞–Ω</button>
                <button class="btn-secondary" onclick="playerAccept()">–ü—Ä–∏–Ω—è—Ç—å</button>
            </div>
        `;
        specialMechanics.style.display = 'block';
    }

    function playerAccuse(cheatType) {
        const isCorrectAccusation = Math.random() > 0.5;

        if (isCorrectAccusation) {
            showPlayerMessage('‚úÖ –í–µ—Ä–Ω–æ! –í—ã —Ä–∞–∑–æ–±–ª–∞—á–∏–ª–∏ –∂—É–ª—å–Ω–∏—á–µ—Å—Ç–≤–æ!', 'success');
            playerWins++;
        } else {
            showPlayerMessage('‚ùå –ù–µ–≤–µ—Ä–Ω–æ! –î–∏–ª–µ—Ä –Ω–µ –∂—É–ª—å–Ω–∏—á–∞–ª —Ç–∞–∫–∏–º —Å–ø–æ—Å–æ–±–æ–º.', 'error');
            dealerWins++;
        }

        document.getElementById('playerSpecialMechanics').style.display = 'none';
        updateScores();
        prepareNewRound();
    }

    function playerAccept() {
        document.getElementById('playerSpecialMechanics').style.display = 'none';
        showPlayerMessage('–í—ã –ø—Ä–∏–Ω—è–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—É–Ω–¥–∞.', 'info');
        prepareNewRound();
    }

    // ==================== –õ–û–ì–ò–ö–ê –î–ò–õ–ï–†–ê ====================
    function initializeDealerGame() {
        resetGame();
        showDealerPlacementStage();
    }

    function dealerPlaceBall(cupIndex) {
        currentBallPosition = cupIndex;

        // –ê–Ω–∏–º–∞—Ü–∏—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —à–∞—Ä–∏–∫–∞
        animateBallPlacement(cupIndex);

        showDealerMessage(`–í—ã –ø–æ–º–µ—Å—Ç–∏–ª–∏ —à–∞—Ä–∏–∫ –≤ —Å—Ç–∞–∫–∞–Ω ${cupIndex + 1}`);

        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–∂–∏–¥–∞–Ω–∏—é —Ö–æ–¥–∞ –∏–≥—Ä–æ–∫–∞
        document.getElementById('dealerPlacementStage').style.display = 'none';
        document.getElementById('dealerWaitStage').style.display = 'block';

        // –°–∏–º—É–ª—è—Ü–∏—è —Ö–æ–¥–∞ –∏–≥—Ä–æ–∫–∞ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
        setTimeout(() => {
            showShuffleAnimation();

            setTimeout(() => {
                const playerGuess = Math.floor(Math.random() * 3);
                const isCorrect = (playerGuess === currentBallPosition);
                processDealerTurnResult(isCorrect, playerGuess);
            }, 3000); // –£–º–µ–Ω—å—à–∏–ª –≤—Ä–µ–º—è –¥–æ 3 —Å–µ–∫—É–Ω–¥
        }, 1500);
    }

   function processDealerTurnResult(isCorrect, playerGuess) {
    console.log('P: processDealerTurnResult');
    console.log('P: isCorrect =', isCorrect);
    console.log('P: playerGuess =', playerGuess);
    console.log('P: currentBallPosition =', currentBallPosition);

    if (isCorrect) {
        console.log('P: –ò–≥—Ä–æ–∫ —É–≥–∞–¥–∞–ª! –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø—Ü–∏–∏ –∂—É–ª—å–Ω–∏—á–µ—Å—Ç–≤–∞');
        playerGuessPosition = playerGuess;
        currentBallPositionBeforeCheat = currentBallPosition;

        console.log('P: playerGuessPosition =', playerGuessPosition);
        console.log('P: currentBallPositionBeforeCheat =', currentBallPositionBeforeCheat);

        showDealerMessage(`–ò–≥—Ä–æ–∫ —É–≥–∞–¥–∞–ª! –û–Ω –≤—ã–±—Ä–∞–ª —Å—Ç–∞–∫–∞–Ω ${playerGuess + 1}`);

        document.getElementById('dealerWaitStage').style.display = 'none';
        document.getElementById('dealerCheatStage').style.display = 'block';
    } else {
        showDealerMessage(`–ò–≥—Ä–æ–∫ –Ω–µ —É–≥–∞–¥–∞–ª! –û–Ω –≤—ã–±—Ä–∞–ª —Å—Ç–∞–∫–∞–Ω ${playerGuess + 1}`);
        dealerWins++;

        const roundResult = {
            round: currentRound,
            playerGuess: playerGuess,
            actualPosition: currentBallPosition,
            correct: false,
            dealerCheated: false
        };
        gameHistory.push(roundResult);

        updateScores();
        currentRound++;
        updateRoundInfo();

        if (checkGameOver()) {
            showFinalResults();
        } else {
            setTimeout(() => showDealerPlacementStage(), 2000);
        }
    }
}





function dealerCheat(cheatType) {
    console.log('=== dealerCheat –ù–ê–ß–ê–õ–û ===');
    console.log('–í—ã–±—Ä–∞–Ω —Ç–∏–ø –∂—É–ª—å–Ω–∏—á–µ—Å—Ç–≤–∞:', cheatType);
    console.log('currentBallPosition:', currentBallPosition);
    console.log('playerGuessPosition:', playerGuessPosition);

    let message = '';
    let newBallPosition = currentBallPosition;
    let availablePositions = [];

    switch(cheatType) {
        case 'hide':
            console.log('–í—ã–±—Ä–∞–Ω hide - –ø—Ä—è—á–µ–º —à–∞—Ä–∏–∫');
            message = '–í—ã —Å–ø—Ä—è—Ç–∞–ª–∏ —à–∞—Ä–∏–∫ –≤ —Ä—É–∫–∞–≤!';
            newBallPosition = -1;

            showDealerMessage('üé© –ü—Ä—è—á—É —à–∞—Ä–∏–∫ –≤ —Ä—É–∫–∞–≤...');
            animateHideBall(currentBallPosition);

            setTimeout(() => {
                console.log('–ó–∞–≤–µ—Ä—à–∞–µ–º hide —á–µ—Ä–µ–∑ completeDealerCheatRound');
                completeDealerCheatRound(message, newBallPosition, cheatType);
            }, 1500);
            return;

        case 'swap':
            console.log('–í—ã–±—Ä–∞–Ω swap - –ø–µ—Ä–µ–∫–ª–∞–¥—ã–≤–∞–µ–º —à–∞—Ä–∏–∫');

            // –°–û–ó–î–ê–ï–ú –°–ü–ò–°–û–ö –î–û–°–¢–£–ü–ù–´–• –°–¢–ê–ö–ê–ù–û–í
            availablePositions = [0, 1, 2].filter(pos =>
                pos !== currentBallPosition &&
                pos !== playerGuessPosition
            );

            console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–∞–∫–∞–Ω—ã –¥–ª—è swap:', availablePositions);

            if (availablePositions.length === 0) {
                console.log('ERROR: –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–∞–∫–∞–Ω–æ–≤ –¥–ª—è swap!');
                showDealerMessage('–û—à–∏–±–∫–∞: –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–∞–∫–∞–Ω–æ–≤!', 'error');
                return;
            }

            // –ü–û–ö–ê–ó–´–í–ê–ï–ú –í–´–ë–û–† –°–¢–ê–ö–ê–ù–ê –î–ò–õ–ï–†–£
            console.log('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Å—Ç–∞–∫–∞–Ω–∞...');
            showSwapSelectionMenu(availablePositions);
            return;

        case 'add':
            console.log('–í—ã–±—Ä–∞–Ω add - –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–∫–∞–Ω');
            message = '–í—ã –¥–æ–±–∞–≤–∏–ª–∏ —á–µ—Ç–≤–µ—Ä—Ç—ã–π —Å—Ç–∞–∫–∞–Ω! –®–∞—Ä–∏–∫ –æ—Å—Ç–∞–ª—Å—è –Ω–∞ –º–µ—Å—Ç–µ.';
            newBallPosition = currentBallPosition;
            showDealerMessage('‚ûï –î–æ–±–∞–≤–ª—è—é —Å—Ç–∞–∫–∞–Ω...');

            // –ê–Ω–∏–º–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞–∫–∞–Ω–∞
            const cupsContainer = document.querySelector('#dealerWaitStage .cups-container');
            if (cupsContainer) {
                const newCup = document.createElement('div');
                newCup.className = 'cup';
                newCup.textContent = 'ü•§ 4';
                newCup.style.animation = 'ballDrop 1s ease-in-out';
                cupsContainer.appendChild(newCup);
            }

            setTimeout(() => {
                console.log('–ó–∞–≤–µ—Ä—à–∞–µ–º add —á–µ—Ä–µ–∑ completeDealerCheatRound');
                completeDealerCheatRound(message, newBallPosition, cheatType, [3]);
            }, 1500);
            return;

        default:
            console.error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∂—É–ª—å–Ω–∏—á–µ—Å—Ç–≤–∞:', cheatType);
            return;
    }
}











// ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ñ–£–õ–¨–ù–ò–ß–ï–°–¢–í–ê ====================





// 1. –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∂—É–ª—å–Ω–∏—á–µ—Å—Ç–≤–∞
function completeDealerCheatRound(message, newBallPosition, cheatType, availablePositions = []) {
    console.log('=== completeDealerCheatRound –ù–ê–ß–ê–õ–û ===');
    console.log('cheatType:', cheatType);
    console.log('newBallPosition:', newBallPosition);
    console.log('message:', message);

    if (cheatType === 'swap') {
        console.log('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º swap, –≤—ã–∑—ã–≤–∞–µ–º handleSwapSecondChance');
        // –î–ª—è swap –æ—Å–æ–±–∞—è –ª–æ–≥–∏–∫–∞ - –¥–∞–µ–º –∏–≥—Ä–æ–∫—É –≤—Ç–æ—Ä–æ–π —à–∞–Ω—Å
        handleSwapSecondChance(newBallPosition, message);
        return;
    }

    console.log('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∂—É–ª—å–Ω–∏—á–µ—Å—Ç–≤–æ, –≤—ã–∑—ã–≤–∞–µ–º completeStandardCheatRound');
    // –î–ª—è hide –∏ add - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
    completeStandardCheatRound(message, newBallPosition, cheatType);
}











// 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ç–æ—Ä–æ–≥–æ —à–∞–Ω—Å–∞ –ø—Ä–∏ swap
function handleSwapSecondChance(newBallPosition, message) {
    console.log('=== handleSwapSecondChance –ù–ê–ß–ê–õ–û ===');
    console.log('–ù–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è —à–∞—Ä–∏–∫–∞:', newBallPosition);
    console.log('–°–æ–æ–±—â–µ–Ω–∏–µ:', message);
    console.log('playerGuessPosition (–ø–µ—Ä–≤—ã–π –≤—ã–±–æ—Ä –∏–≥—Ä–æ–∫–∞):', playerGuessPosition);

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —à–∞—Ä–∏–∫–∞
    currentBallPosition = newBallPosition;
    console.log('currentBallPosition –æ–±–Ω–æ–≤–ª–µ–Ω:', currentBallPosition);

    showDealerMessage(message + ' –ò–≥—Ä–æ–∫ –ø–æ–ª—É—á–∞–µ—Ç –≤—Ç–æ—Ä–æ–π —à–∞–Ω—Å —É–≥–∞–¥–∞—Ç—å!');

    // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –∂—É–ª—å–Ω–∏—á–µ—Å—Ç–≤–∞
    if (document.getElementById('dealerCheatStage')) {
        console.log('–°–∫—Ä—ã–≤–∞–µ–º dealerCheatStage');
        document.getElementById('dealerCheatStage').style.display = 'none';
    } else {
        console.log('WARNING: dealerCheatStage –Ω–µ –Ω–∞–π–¥–µ–Ω!');
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ
    console.log('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º dealerWaitStage');
    document.getElementById('dealerWaitStage').style.display = 'block';
    document.getElementById('dealerWaitMessage').textContent = '–ò–≥—Ä–æ–∫ —É–≥–∞–¥—ã–≤–∞–µ—Ç –≤—Ç–æ—Ä–æ–π —Ä–∞–∑...';

    console.log('–ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–º—É–ª—è—Ü–∏—é –≤—Ç–æ—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã...');

    // –°–∏–º—É–ª–∏—Ä—É–µ–º –≤—Ç–æ—Ä–æ–π –≤—ã–±–æ—Ä –∏–≥—Ä–æ–∫–∞ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        console.log('–¢–∞–π–º–∞—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º simulatePlayerSecondGuess()');
        simulatePlayerSecondGuess();
    }, 3000);
}











function handleSwapSelection(targetPosition) {
    console.log('–î–∏–ª–µ—Ä –≤—ã–±—Ä–∞–ª —Å—Ç–∞–∫–∞–Ω –¥–ª—è swap:', targetPosition);

    let message = `–í—ã –ø–µ—Ä–µ–ª–æ–∂–∏–ª–∏ —à–∞—Ä–∏–∫ –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ ${currentBallPosition + 1} –≤ —Å—Ç–∞–∫–∞–Ω ${targetPosition + 1}!`;

    showDealerMessage(`üîÑ –ü–µ—Ä–µ–∫–ª–∞–¥—ã–≤–∞—é –≤ —Å—Ç–∞–∫–∞–Ω ${targetPosition + 1}...`);
    animateSwapBall(currentBallPosition, targetPosition);

    // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞
    document.getElementById('dealerCheatStage').style.display = 'none';

    // –ñ–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
    setTimeout(() => {
        // –ò–°–ü–†–ê–í–õ–ï–ù–û: –≤—ã–∑—ã–≤–∞–µ–º completeDealerCheatRound
        completeDealerCheatRound(message, targetPosition, 'swap');
    }, 1500);
}






// 3. –°–∏–º—É–ª—è—Ü–∏—è –≤—Ç–æ—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞ –∏–≥—Ä–æ–∫–∞
function simulatePlayerSecondGuess() {
    console.log('=== simulatePlayerSecondGuess –ù–ê–ß–ê–õ–û ===');
    console.log('playerGuessPosition (–ø–µ—Ä–≤—ã–π –≤—ã–±–æ—Ä):', playerGuessPosition);
    console.log('currentBallPosition (—Ç–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è):', currentBallPosition);

    if (playerGuessPosition === null || playerGuessPosition === undefined) {
        console.error('ERROR: playerGuessPosition –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω!');
        return;
    }

    // –ò–≥—Ä–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Ç–æ—Ç –∂–µ —Å—Ç–∞–∫–∞–Ω, —á—Ç–æ –∏ –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑
    const availableCups = [0, 1, 2].filter(pos => pos !== playerGuessPosition);
    console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–∞–∫–∞–Ω—ã –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞:', availableCups);

    if (availableCups.length === 0) {
        console.error('ERROR: –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–∞–∫–∞–Ω–æ–≤ –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞!');
        return;
    }

    const secondGuess = availableCups[Math.floor(Math.random() * availableCups.length)];
    console.log('–ò–≥—Ä–æ–∫ –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ –≤—ã–±–∏—Ä–∞–µ—Ç —Å—Ç–∞–∫–∞–Ω:', secondGuess);

    const isCorrect = (secondGuess === currentBallPosition);
    console.log('–ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏?', isCorrect);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –∏–≥—Ä–æ–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–µ–π
    highlightDealerCupForSecondGuess(secondGuess);

    showDealerMessage(`–ò–≥—Ä–æ–∫ —Å–Ω–æ–≤–∞ –≤—ã–±–∏—Ä–∞–µ—Ç —Å—Ç–∞–∫–∞–Ω ${secondGuess + 1}...`);

    setTimeout(() => {
        console.log('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—Ç–æ—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞...');
        if (isCorrect) {
            console.log('–ò–≥—Ä–æ–∫ —É–≥–∞–¥–∞–ª —Å–Ω–æ–≤–∞!');
            showDealerMessage(`‚ùå –ò–≥—Ä–æ–∫ —É–≥–∞–¥–∞–ª —Å–Ω–æ–≤–∞! –®–∞—Ä–∏–∫ –±—ã–ª –≤ ${currentBallPosition + 1}. –ü–æ–±–µ–¥–∞ –∏–≥—Ä–æ–∫–∞.`, 'error');
            playerWins++;
            console.log('playerWins —É–≤–µ–ª–∏—á–µ–Ω –¥–æ:', playerWins);
        } else {
            console.log('–ò–≥—Ä–æ–∫ –æ—à–∏–±—Å—è!');
            showDealerMessage(`‚úÖ –ò–≥—Ä–æ–∫ –æ—à–∏–±—Å—è! –®–∞—Ä–∏–∫ –±—ã–ª –≤ ${currentBallPosition + 1}, –∞ –æ–Ω –≤—ã–±—Ä–∞–ª ${secondGuess + 1}. –ü–æ–±–µ–¥–∞ –¥–∏–ª–µ—Ä–∞.`, 'success');
            dealerWins++;
            console.log('dealerWins —É–≤–µ–ª–∏—á–µ–Ω –¥–æ:', dealerWins);
        }

        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—É–Ω–¥–∞ —Å swap
        const roundResult = {
            round: currentRound,
            playerFirstGuess: playerGuessPosition,
            playerSecondGuess: secondGuess,
            originalBallPosition: currentBallPositionBeforeCheat,
            finalBallPosition: currentBallPosition,
            firstGuessCorrect: true,
            secondGuessCorrect: isCorrect,
            dealerCheated: true,
            cheatType: 'swap',
            finalResult: isCorrect ? 'player' : 'dealer'
        };
        gameHistory.push(roundResult);
        console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø–∏—Å–∞–Ω –≤ gameHistory');

        console.log('–í—ã–∑—ã–≤–∞–µ–º finishRoundAfterCheat()');
        // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞—É–Ω–¥
        finishRoundAfterCheat();
    }, 2000);
}




















// 4. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å—Ç–∞–∫–∞–Ω–∞ –ø—Ä–∏ –≤—Ç–æ—Ä–æ–º –≤—ã–±–æ—Ä–µ
function highlightDealerCupForSecondGuess(cupIndex) {
    const cups = document.querySelectorAll('#dealerWaitCups .cup');
    cups.forEach((cup, index) => {
        cup.classList.remove('selected');
        if (index === cupIndex) {
            cup.classList.add('selected');
            cup.style.background = 'rgba(255, 215, 0, 0.5)';
        }
    });
}

// 5. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö cheat (hide, add)
function completeStandardCheatRound(message, newBallPosition, cheatType) {
    console.log('completeStandardCheatRound:', cheatType);

    currentBallPosition = newBallPosition;

    showDealerMessage(message);

    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—É–Ω–¥–∞
    const roundResult = {
        round: currentRound,
        playerGuess: playerGuessPosition,
        originalBallPosition: currentBallPositionBeforeCheat,
        finalBallPosition: newBallPosition,
        correct: true,
        dealerCheated: true,
        cheatType: cheatType,
        finalResult: 'dealer'
    };
    gameHistory.push(roundResult);

    // –î–∏–ª–µ—Ä –≤—ã–∏–≥—Ä—ã–≤–∞–µ—Ç —Ä–∞—É–Ω–¥ –±–ª–∞–≥–æ–¥–∞—Ä—è –∂—É–ª—å–Ω–∏—á–µ—Å—Ç–≤—É
    dealerWins++;

    // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞—É–Ω–¥
    finishRoundAfterCheat();
}

// 6. –û–±—â–µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞—É–Ω–¥–∞ –ø–æ—Å–ª–µ –∂—É–ª—å–Ω–∏—á–µ—Å—Ç–≤–∞
function finishRoundAfterCheat() {
    console.log('finishRoundAfterCheat');

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç
    updateScores();

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    playerGuessPosition = null;
    currentBallPositionBeforeCheat = null;

    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–∞—É–Ω–¥—É
    currentRound++;
    updateRoundInfo();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã
    if (checkGameOver()) {
        setTimeout(() => {
            showFinalResults();
        }, 3000);
    } else {
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é —à–∞—Ä–∏–∫–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞
        setTimeout(() => {
            showDealerPlacementStage();
        }, 3000);
    }
}













function showSwapSelectionMenu(availablePositions) {
    console.log('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Å—Ç–∞–∫–∞–Ω–∞ –¥–ª—è swap');

    // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –∂—É–ª—å–Ω–∏—á–µ—Å—Ç–≤–∞
    document.getElementById('dealerCheatStage').style.display = 'none';

    // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç–∞–∫–∞–Ω–∞
    let swapSelectionHTML = `
        <div class="message">üé© –í—ã–±–µ—Ä–∏—Ç–µ –∫—É–¥–∞ –ø–µ—Ä–µ–ª–æ–∂–∏—Ç—å —à–∞—Ä–∏–∫:</div>
        <div class="cups-container">
            ${[0, 1, 2].map(i => {
                if (i === currentBallPosition) {
                    return `<div class="cup" style="background: rgba(255,0,0,0.3); cursor: not-allowed;">
                        ü•§ ${i + 1}<br>
                        <small>‚ùå —à–∞—Ä–∏–∫ –∑–¥–µ—Å—å</small>
                    </div>`;
                } else if (i === playerGuessPosition) {
                    return `<div class="cup" style="background: rgba(255,255,0,0.3); cursor: not-allowed;">
                        ü•§ ${i + 1}<br>
                        <small>üéØ –∏–≥—Ä–æ–∫ —É–≥–∞–¥–∞–ª</small>
                    </div>`;
                } else if (availablePositions.includes(i)) {
                    return `<div class="cup" onclick="handleSwapSelection(${i})" style="cursor: pointer;">
                        ü•§ ${i + 1}<br>
                        <small>‚úÖ –º–æ–∂–Ω–æ</small>
                    </div>`;
                } else {
                    return `<div class="cup" style="opacity: 0.5; cursor: not-allowed;">
                        ü•§ ${i + 1}<br>
                        <small>üö´ –Ω–µ–ª—å–∑—è</small>
                    </div>`;
                }
            }).join('')}
        </div>
        <div style="margin-top: 20px;">
            <button class="btn-secondary" onclick="cancelSwap()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    `;

    // –í—Ä–µ–º–µ–Ω–Ω–æ –∏–∑–º–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ dealerCheatStage
    let cheatStage = document.getElementById('dealerCheatStage');
    cheatStage.innerHTML = swapSelectionHTML;
    cheatStage.style.display = 'block';
}

function handleSwapSelection(targetPosition) {
    console.log('–î–∏–ª–µ—Ä –≤—ã–±—Ä–∞–ª —Å—Ç–∞–∫–∞–Ω –¥–ª—è swap:', targetPosition);

    let message = `–í—ã –ø–µ—Ä–µ–ª–æ–∂–∏–ª–∏ —à–∞—Ä–∏–∫ –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ ${currentBallPosition + 1} –≤ —Å—Ç–∞–∫–∞–Ω ${targetPosition + 1}!`;

    showDealerMessage(`üîÑ –ü–µ—Ä–µ–∫–ª–∞–¥—ã–≤–∞—é –≤ —Å—Ç–∞–∫–∞–Ω ${targetPosition + 1}...`);
    animateSwapBall(currentBallPosition, targetPosition);

    // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞
    document.getElementById('dealerCheatStage').style.display = 'none';

    // –ñ–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
    setTimeout(() => {
        continueAfterCheat(message, targetPosition, 'swap', [targetPosition]);
    }, 1500);
}

function cancelSwap() {
    console.log('–û—Ç–º–µ–Ω–∞ swap');
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –≤—ã–±–æ—Ä—É –∂—É–ª—å–Ω–∏—á–µ—Å—Ç–≤–∞
    let cheatStage = document.getElementById('dealerCheatStage');
    cheatStage.innerHTML = `
        <div class="message">–ò–≥—Ä–æ–∫ —É–≥–∞–¥–∞–ª! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:</div>
        <div class="cheat-options">
            <button class="cheat-option" onclick="dealerCheat('hide')">üé© –°–ø—Ä—è—Ç–∞—Ç—å –≤ —Ä—É–∫–∞–≤</button>
            <button class="cheat-option" onclick="dealerCheat('swap')">üîÑ –ü–µ—Ä–µ–ª–æ–∂–∏—Ç—å —à–∞—Ä–∏–∫</button>
            <button class="cheat-option" onclick="dealerCheat('add')">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–∫–∞–Ω</button>
            <button class="btn-secondary" onclick="dealerAcceptLoss()">–ü—Ä–∏–Ω—è—Ç—å –ø–æ—Ä–∞–∂–µ–Ω–∏–µ</button>
        </div>
    `;
    cheatStage.style.display = 'block';
}












    function dealerAcceptLoss() {
        showDealerMessage('–í—ã –ø—Ä–∏–Ω—è–ª–∏ –ø–æ—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ä–∞—É–Ω–¥–µ.');

        const roundResult = {
            round: currentRound,
            playerGuess: playerGuessPosition,
            actualPosition: currentBallPosition,
            correct: true,
            dealerCheated: false
        };
        gameHistory.push(roundResult);

        playerWins++;
        document.getElementById('dealerCheatStage').style.display = 'none';
        updateScores();
        currentRound++;
        updateRoundInfo();

        playerGuessPosition = null;
        currentBallPositionBeforeCheat = null;

        if (checkGameOver()) {
            showFinalResults();
        } else {
            setTimeout(() => showDealerPlacementStage(), 2000);
        }
    }

    function showDealerPlacementStage() {
        document.getElementById('dealerPlacementStage').style.display = 'block';
        document.getElementById('dealerWaitStage').style.display = 'none';
        document.getElementById('dealerCheatStage').style.display = 'none';
        showDealerMessage('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–∫–∞–Ω –∫—É–¥–∞ –ø–æ–ª–æ–∂–∏—Ç—å —à–∞—Ä–∏–∫:');
    }

    // ==================== –û–ë–©–ò–ï –§–£–ù–ö–¶–ò–ò ====================
    function showPlayerMessage(message, type = 'info') {
        const gameMessage = document.getElementById('playerGameMessage');
        gameMessage.textContent = message;
        gameMessage.style.background = getMessageColor(type);
    }

    function showDealerMessage(message, type = 'info') {
        const waitMessage = document.getElementById('dealerWaitMessage');
        if (waitMessage) waitMessage.textContent = message;
        if (type !== 'info') {
            waitMessage.style.background = getMessageColor(type);
        }
    }

    function getMessageColor(type) {
        const colors = {
            success: 'rgba(76, 175, 80, 0.3)',
            error: 'rgba(244, 67, 54, 0.3)',
            warning: 'rgba(255, 152, 0, 0.3)',
            info: 'rgba(0, 0, 0, 0.2)'
        };
        return colors[type] || colors.info;
    }

    function highlightPlayerCup(index) {
        document.querySelectorAll('#playerCupsContainer .cup').forEach((cup, i) => {
            cup.classList.toggle('selected', i === index);
        });
    }

    function showBallPosition(position, isCorrect) {
        const cups = document.querySelectorAll('.cup');
        if (cups[position]) {
            cups[position].textContent = isCorrect ? 'üéØ' : '‚ùå';
            cups[position].style.background = isCorrect ? 'rgba(255,215,0,0.3)' : 'rgba(244,67,54,0.3)';
        }
    }

    function disablePlayerCups() {
        document.querySelectorAll('#playerCupsContainer .cup').forEach(cup => {
            cup.style.pointerEvents = 'none';
        });
    }

    function enablePlayerCups() {
        document.querySelectorAll('#playerCupsContainer .cup').forEach(cup => {
            cup.style.pointerEvents = 'auto';
            cup.textContent = 'ü•§';
            cup.style.background = 'rgba(255,255,255,0.1)';
            cup.classList.remove('selected');
            cup.classList.remove('has-ball', 'shuffling', 'moving-left', 'moving-right');
        });
    }

    function resetGame() {
        currentRound = 1;
        playerWins = 0;
        dealerWins = 0;
        gameFinished = false;
        gameHistory = [];
        currentGameId = 'game_' + Date.now();
        currentBallPosition = null;
        playerGuessPosition = null;
        currentBallPositionBeforeCheat = null;

        updateScores();
        updateRoundInfo();
        enablePlayerCups();
        document.getElementById('playerSpecialMechanics').style.display = 'none';
    }

    function updateScores() {
        document.getElementById('playerScore').textContent = playerWins;
        document.getElementById('dealerScore').textContent = dealerWins;
        document.getElementById('dealerViewPlayerScore').textContent = playerWins;
        document.getElementById('dealerViewDealerScore').textContent = dealerWins;
    }

    function updateRoundInfo() {
        document.getElementById('playerRoundNumber').textContent = currentRound;
        document.getElementById('dealerRoundNumber').textContent = currentRound;
    }

    function checkGameOver() {
        if (playerWins >= winsToWinGame || dealerWins >= winsToWinGame || currentRound > maxRounds) {
            gameFinished = true;
            return true;
        }
        return false;
    }

    function prepareNewRound() {
        currentBallPosition = null;
        playerGuessPosition = null;
        currentBallPositionBeforeCheat = null;
        enablePlayerCups();

        if (selectedRole === 'player') {
            showPlayerMessage('–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞...', 'info');
        }

        setTimeout(() => {
            if (selectedRole === 'player') {
                showPlayerMessage('–ù–æ–≤—ã–π —Ä–∞—É–Ω–¥ –Ω–∞—á–∞–ª—Å—è! –£–≥–∞–¥–∞–π—Ç–µ –≥–¥–µ —à–∞—Ä–∏–∫.', 'info');
            }
        }, 2000);
    }








   function showFinalResults() {
    let resultMessage = '';
    if (playerWins > dealerWins) {
        resultMessage = 'üéâ –ü–û–ë–ï–î–ê –ò–ì–†–û–ö–ê!';
    } else if (dealerWins > playerWins) {
        resultMessage = 'üé© –ü–û–ë–ï–î–ê –î–ò–õ–ï–†–ê!';
    } else {
        resultMessage = 'ü§ù –ù–∏—á—å—è!';
    }

    document.getElementById('finalResult').textContent = `${resultMessage} –°—á–µ—Ç: ${playerWins}-${dealerWins}`;

    const statsContent = document.getElementById('statsContent');
    let statsHTML = `<p>–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—á–µ—Ç: <strong>${playerWins}-${dealerWins}</strong></p>`;
    statsHTML += `<p>–°—ã–≥—Ä–∞–Ω–æ —Ä–∞—É–Ω–¥–æ–≤: <strong>${currentRound - 1}</strong></p>`;
    statsHTML += `<h4>–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—É–Ω–¥–æ–≤:</h4>`;

    gameHistory.forEach((round, index) => {
        statsHTML += `<p style="margin: 5px 0; padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.1);">`;
        statsHTML += `<strong>–†–∞—É–Ω–¥ ${round.round}:</strong> `;

        if (round.playerFirstGuess !== undefined) {
            // –≠—Ç–æ —Ä–∞—É–Ω–¥ —Å swap
            statsHTML += `–ü–µ—Ä–≤—ã–π –≤—ã–±–æ—Ä: ${round.playerFirstGuess + 1}, `;
            statsHTML += `–í—Ç–æ—Ä–æ–π –≤—ã–±–æ—Ä: ${round.playerSecondGuess + 1}, `;
            statsHTML += `–®–∞—Ä–∏–∫ –±—ã–ª: ${round.originalBallPosition + 1} ‚Üí ${round.finalBallPosition + 1}, `;
            statsHTML += round.secondGuessCorrect ? '‚úÖ –£–≥–∞–¥–∞–ª' : '‚ùå –ù–µ —É–≥–∞–¥–∞–ª';
            statsHTML += ` (swap)`;
        } else {
            // –û–±—ã—á–Ω—ã–π —Ä–∞—É–Ω–¥
            statsHTML += `–ò–≥—Ä–æ–∫ ‚Üí ${round.playerGuess + 1}, `;
            if (round.actualPosition !== undefined) {
                statsHTML += `–®–∞—Ä–∏–∫ ‚Üí ${round.actualPosition + 1}, `;
            }
            statsHTML += round.correct ? '‚úÖ –£–≥–∞–¥–∞–ª' : '‚ùå –ù–µ —É–≥–∞–¥–∞–ª';

            if (round.dealerCheated) {
                statsHTML += `, üé© ${round.cheatType}`;
            }
        }
        statsHTML += `</p>`;
    });

    statsContent.innerHTML = statsHTML;
    showScreen('resultsScreen');
}

function startNewGame() {
    resetGame();
    if (selectedRole === 'player') {
        showScreen('playerGameScreen');
        showPlayerMessage('–ì–æ—Ç–æ–≤—ã –∫ –Ω–æ–≤–æ–π –∏–≥—Ä–µ!', 'info');
    } else {
        showScreen('dealerGameScreen');
        showDealerPlacementStage();
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ –ò–≥—Ä–∞ "–ù–∞–ø–µ—Ä—Å—Ç–∫–∏" –∑–∞–≥—Ä—É–∂–µ–Ω–∞!');
    showScreen('welcomeScreen');
});











    function startNewGame() {
        resetGame();
        if (selectedRole === 'player') {
            showScreen('playerGameScreen');
            showPlayerMessage('–ì–æ—Ç–æ–≤—ã –∫ –Ω–æ–≤–æ–π –∏–≥—Ä–µ!', 'info');
        } else {
            showScreen('dealerGameScreen');
            showDealerPlacementStage();
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üéØ –ò–≥—Ä–∞ "–ù–∞–ø–µ—Ä—Å—Ç–∫–∏" –∑–∞–≥—Ä—É–∂–µ–Ω–∞!');
        showScreen('welcomeScreen');
    });
</script>
</body>
</html>