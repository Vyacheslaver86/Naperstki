<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞–ø–µ—Ä—Å—Ç–∫–∏ - –ò–≥—Ä–∞</title>
    <style>
        /* ==================== CSS –°–¢–ò–õ–ò ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
            padding: 20px;
        }

        /* –≠–∫—Ä–∞–Ω */
        .screen {
            display: none;
            text-align: center;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 40px;
            backdrop-filter: blur(10px);
            min-height: 500px;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .screen.active {
            display: flex;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
        h1 {
            font-size: 3em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }

        h2 {
            font-size: 2em;
            margin-bottom: 20px;
        }

        h3 {
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-primary {
            background: #4CAF50;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.3s;
            margin: 10px;
            min-width: 200px;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #ff6b6b;
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            margin: 5px;
        }

        .btn-warning {
            background: #ff9800;
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            margin: 5px;
        }

        /* –§–æ—Ä–º—ã */
        .auth-form {
            width: 100%;
            max-width: 400px;
        }

        .auth-form input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            border: none;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
        }

        .auth-tabs button {
            flex: 1;
            padding: 15px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }

        .auth-tabs .tab-active {
            background: #4CAF50;
        }

        .auth-tab {
            display: none;
        }

        .auth-tab.active {
            display: block;
        }

        /* –í—ã–±–æ—Ä —Ä–æ–ª–∏ */
        .role-options {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .role-btn {
            background: rgba(255,255,255,0.1);
            border: 3px solid transparent;
            padding: 30px 20px;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            font-size: 1.3em;
            transition: all 0.3s;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .role-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-5px);
        }

        .role-btn.selected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        }

        .role-icon {
            font-size: 2em;
        }

        .role-description {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* –ò–≥—Ä–æ–≤–∞—è –∑–æ–Ω–∞ */
        .game-area {
            width: 100%;
        }

        .cups-container {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 40px 0;
        }

        .cup {
            font-size: 4em;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 20px;
            border-radius: 15px;
            background: rgba(255,255,255,0.1);
        }

        .cup:hover {
            transform: translateY(-10px);
            background: rgba(255,255,255,0.2);
        }

        .cup.selected {
            background: rgba(255,215,0,0.3);
            transform: scale(1.1);
        }

        /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∏–≥—Ä–µ */
        .game-info {
            margin: 20px 0;
        }

        .score {
            display: flex;
            justify-content: center;
            gap: 30px;
            font-size: 1.2em;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .score span {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 10px;
        }

        .message {
            font-size: 1.3em;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏ */
        .special-mechanics {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .mechanic-option {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 15px 25px;
            margin: 10px;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-size: 1.1em;
            transition: background 0.3s;
        }

        .mechanic-option:hover {
            background: rgba(255,255,255,0.3);
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            text-align: left;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .user-info button {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }

            .screen {
                padding: 20px;
            }

            h1 {
                font-size: 2em;
            }

            .cups-container {
                gap: 15px;
            }

            .cup {
                font-size: 3em;
                padding: 15px;
            }

            .role-options {
                flex-direction: column;
                gap: 15px;
            }

            .role-btn {
                min-width: auto;
                padding: 20px 15px;
            }
        }
    </style>
</head>
<body>
<div class="user-info" id="userInfo" style="display: none;">
    <span id="userGreeting"></span>
    <button onclick="logout()">–í—ã–π—Ç–∏</button>
</div>

<div class="container">
    <!-- –≠–ö–†–ê–ù 1: –ü–†–ò–í–ï–¢–°–¢–í–ò–ï -->
    <div class="screen active" id="welcomeScreen">
        <div>
            <h1>üéØ –ù–∞–ø–µ—Ä—Å—Ç–∫–∏</h1>
            <p style="font-size: 1.2em; margin-bottom: 30px; opacity: 0.9;">
                –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∏–≥—Ä–∞ –≤ –Ω–∞–ø–µ—Ä—Å—Ç–∫–∏ —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ –±–ª–µ—Ñ–∞!
            </p>
            <button class="btn-primary" onclick="showScreen('authScreen')">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 2: –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø -->
    <div class="screen" id="authScreen">
        <div class="auth-form">
            <h2>–í—Ö–æ–¥ –≤ –∏–≥—Ä—É</h2>
            <div class="auth-tabs">
                <button class="tab-active" onclick="showAuthTab('login')">–í—Ö–æ–¥</button>
                <button onclick="showAuthTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>

            <div class="auth-tab active" id="loginTab">
                <input type="text" id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                <button class="btn-primary" onclick="login()">–í–æ–π—Ç–∏</button>
            </div>

            <div class="auth-tab" id="registerTab">
                <input type="text" id="regUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                <input type="text" id="regNickname" placeholder="–ù–∏–∫–Ω–µ–π–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                <button class="btn-primary" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>

            <button class="btn-secondary" onclick="showScreen('welcomeScreen')" style="margin-top: 20px;">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 3: –í–´–ë–û–† –†–û–õ–ò -->
    <div class="screen" id="roleScreen">
        <div>
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</h2>
            <p style="margin-bottom: 30px; font-size: 1.1em;">–ö–µ–º –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏–≥—Ä–∞—Ç—å –≤ —ç—Ç–æ–π –ø–∞—Ä—Ç–∏–∏?</p>

            <div class="role-options">
                <div class="role-btn selected" onclick="selectRole('PLAYER')">
                    <div class="role-icon">üéØ</div>
                    <div>–ò–≥—Ä–æ–∫</div>
                    <div class="role-description">–£–≥–∞–¥—ã–≤–∞—Ç—å –≥–¥–µ —à–∞—Ä–∏–∫</div>
                </div>
                <div class="role-btn" onclick="selectRole('DEALER')">
                    <div class="role-icon">üé©</div>
                    <div>–î–∏–ª–µ—Ä</div>
                    <div class="role-description">–ó–∞–≥–∞–¥—ã–≤–∞—Ç—å —à–∞—Ä–∏–∫</div>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <button class="btn-primary" onclick="startGameSession()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
                <button class="btn-secondary" onclick="showScreen('authScreen')">–ù–∞–∑–∞–¥</button>
            </div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 4: –ò–ì–†–ê -->
    <div class="screen" id="gameScreen">
        <div class="game-area">
            <h2 id="gameTitle">üéØ –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!</h2>

            <!-- –°—Ç–∞–∫–∞–Ω—ã -->
            <div class="cups-container" id="cupsContainer">
                <div class="cup" onclick="makeGuess(0)">ü•§ 1</div>
                <div class="cup" onclick="makeGuess(1)">ü•§ 2</div>
                <div class="cup" onclick="makeGuess(2)">ü•§ 3</div>
            </div>

            <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã -->
            <div class="game-info">
                <div class="score">
                    <span>–ò–≥—Ä–æ–∫: <span id="playerScore">0</span>/3</span>
                    <span>–î–∏–ª–µ—Ä: <span id="dealerScore">0</span>/3</span>
                    <span>–†–∞—É–Ω–¥: <span id="roundNumber">1</span>/5</span>
                </div>
                <div class="message" id="gameMessage">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–∫–∞–Ω –≥–¥–µ —à–∞—Ä–∏–∫!</div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="actions">
                <button class="btn-primary" onclick="nextRound()" id="nextRoundBtn" style="display: none;">–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥</button>
                <button class="btn-secondary" onclick="endGame()">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É</button>
            </div>

            <!-- –ó–æ–Ω–∞ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∫ -->
            <div class="special-mechanics" id="specialMechanics" style="display: none;"></div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="stats" id="gameStats" style="display: none;">
                <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä—ã:</h3>
                <div id="statsContent"></div>
            </div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 5: –†–ï–ó–£–õ–¨–¢–ê–¢–´ -->
    <div class="screen" id="resultsScreen">
        <div>
            <h2 id="resultsTitle">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã</h2>
            <div class="stats" id="finalStats" style="max-width: 500px;"></div>
            <div style="margin-top: 30px;">
                <button class="btn-primary" onclick="showScreen('roleScreen')">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
                <button class="btn-secondary" onclick="showScreen('welcomeScreen')">–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ==================== JAVASCRIPT –ö–û–î ====================
    console.log('üéØ –ù–∞–ø–µ—Ä—Å—Ç–∫–∏ - –∏–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è!');

    const API_BASE_URL = 'http://localhost:8081';
    let jwtToken = null;
    let currentUser = null;
    let currentRole = 'PLAYER';
    let currentGameId = null;

    // ==================== –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ò ====================
    let currentRound = 1;
    const maxRounds = 5;
    const winsToWinGame = 3;
    let playerWins = 0;
    let dealerWins = 0;
    let gameFinished = false;
    let gameHistory = [];

    // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –≠–ö–†–ê–ù–ê–ú–ò ====================
    function showScreen(screenId) {
        // –°–∫—Ä—ã—Ç—å –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω
        document.getElementById(screenId).classList.add('active');

        console.log('üñ•Ô∏è –ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ —ç–∫—Ä–∞–Ω:', screenId);
    }

    function showAuthTab(tabName) {
        // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Ç–∞–±—ã
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('.auth-tabs button').forEach(btn => {
            btn.classList.remove('tab-active');
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–±
        document.getElementById(tabName + 'Tab').classList.add('active');
        event.target.classList.add('tab-active');
    }

    // ==================== –í–´–ë–û–† –†–û–õ–ò ====================
    function selectRole(role) {
        currentRole = role;

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
        document.querySelectorAll('.role-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');

        console.log(`üé≠ –í—ã–±—Ä–∞–Ω–∞ —Ä–æ–ª—å: ${getRoleName(role)}`);
    }

    function getRoleName(role) {
        return role === 'PLAYER' ? 'üéØ –ò–≥—Ä–æ–∫' : 'üé© –î–∏–ª–µ—Ä';
    }

    // ==================== –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ====================
    async function login() {
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        if (!username || !password) {
            showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!', 'error');
            return;
        }

        console.log('üîê –ü—ã—Ç–∞–µ–º—Å—è –≤–æ–π—Ç–∏:', username);

        try {
            const response = await fetch(`${API_BASE_URL}/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password })
            });

            console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status);

            if (response.ok) {
                const data = await response.json();
                jwtToken = data.token;
                currentUser = username;
                console.log('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!');

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                document.getElementById('userGreeting').textContent = `–ü—Ä–∏–≤–µ—Ç, ${username}!`;
                document.getElementById('userInfo').style.display = 'block';

                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤—ã–±–æ—Ä—É —Ä–æ–ª–∏
                showScreen('roleScreen');
            } else {
                const error = await response.text();
                console.log('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                alert(error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
            }
        } catch (error) {
            console.error('üí• –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        }
    }

    async function register() {
        const username = document.getElementById('regUsername').value;
        const password = document.getElementById('regPassword').value;
        const nickname = document.getElementById('regNickname').value || username;

        if (!username || !password) {
            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å!');
            return;
        }

        console.log('üìù –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', username);

        try {
            const response = await fetch(`${API_BASE_URL}/auth/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password, nickname })
            });

            console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status);

            if (response.ok) {
                console.log('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
                alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.');
                showAuthTab('login');
                // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
                document.getElementById('regUsername').value = '';
                document.getElementById('regPassword').value = '';
                document.getElementById('regNickname').value = '';
            } else {
                const error = await response.text();
                console.log('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
                alert(error);
            }
        } catch (error) {
            console.error('üí• –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        }
    }

    function logout() {
        console.log('üö™ –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
        jwtToken = null;
        currentUser = null;
        document.getElementById('userInfo').style.display = 'none';
        resetGame();
        showScreen('welcomeScreen');
    }

    // ==================== –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ====================
    function startGameSession() {
        console.log('üéÆ –ù–∞—á–∏–Ω–∞–µ–º –∏–≥—Ä–æ–≤—É—é —Å–µ—Å—Å–∏—é –∫–∞–∫:', currentRole);
        resetGame();
        showScreen('gameScreen');
        startNewGame();
    }

    function resetGame() {
        console.log('üîÑ –°–±—Ä–æ—Å –∏–≥—Ä—ã');
        currentRound = 1;
        playerWins = 0;
        dealerWins = 0;
        gameFinished = false;
        gameHistory = [];
        currentGameId = null;

        updateScores();
        updateRoundInfo();
        resetCups();
        document.getElementById('specialMechanics').style.display = 'none';
        document.getElementById('gameStats').style.display = 'none';
        document.getElementById('nextRoundBtn').style.display = 'none';

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
        const roleName = getRoleName(currentRole);
        document.getElementById('gameTitle').textContent = `${roleName} - –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!`;

        showMessage(currentRole === 'PLAYER'
            ? '–í—ã - –ò–≥—Ä–æ–∫! –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–∫–∞–Ω –≥–¥–µ —à–∞—Ä–∏–∫.'
            : '–í—ã - –î–∏–ª–µ—Ä! –ù–∞—á–Ω–∏—Ç–µ —Ä–∞—É–Ω–¥.', 'info');
    }

    async function startNewGame() {
        if (!jwtToken) {
            showMessage('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
            return;
        }

        currentGameId = 'game_' + Date.now();
        console.log('üÜî ID –∏–≥—Ä—ã:', currentGameId);

        if (currentRole === 'PLAYER') {
            await startPlayerGame();
        } else {
            startDealerGame();
        }
    }

    async function startPlayerGame() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/game/start?gameId=${currentGameId}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${jwtToken}`
                }
            });

            if (response.ok) {
                const gameState = await response.json();
                console.log('‚úÖ –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å:', gameState);
                enableCups();
            } else {
                showMessage('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã', 'error');
            }
        } catch (error) {
            console.error('üí• –û—à–∏–±–∫–∞:', error);
            showMessage('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        }
    }

    function startDealerGame() {
        // –î–ª—è –¥–∏–ª–µ—Ä–∞ - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞
        showMessage('–í—ã - –î–∏–ª–µ—Ä! –ù–∞–∂–º–∏—Ç–µ "–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥" –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏.', 'info');
        document.getElementById('nextRoundBtn').style.display = 'block';
        disableCups();
    }

    async function makeGuess(cupIndex) {
        if (!currentGameId || gameFinished) return;

        highlightCup(cupIndex);
        disableCups();
        showMessage('–ü—Ä–æ–≤–µ—Ä—è–µ–º...', 'info');

        try {
            const response = await fetch(
                `${API_BASE_URL}/api/game/guess?gameId=${currentGameId}&guessedPosition=${cupIndex}`,
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`
                    }
                }
            );

            if (response.ok) {
                const result = await response.json();
                processPlayerRoundResult(result, cupIndex);
            } else {
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–≥–∞–¥—ã–≤–∞–Ω–∏–∏', 'error');
                enableCups();
            }
        } catch (error) {
            console.error('üí• –û—à–∏–±–∫–∞:', error);
            showMessage('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
            enableCups();
        }
    }

    function processPlayerRoundResult(result, playerGuess) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
        const roundResult = {
            round: currentRound,
            playerGuess: playerGuess,
            actualPosition: result.actualBallPosition,
            correct: result.correct,
            dealerCheated: result.dealerCheated,
            cheatType: result.cheatType
        };
        gameHistory.push(roundResult);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç
        if (result.correct) {
            playerWins++;
            showMessage(result.message, 'success');
        } else {
            dealerWins++;
            showMessage(result.message, 'error');
        }

        showBallPosition(result.actualBallPosition);
        updateScores();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ö–∞–Ω–∏–∫–∏ –¥–∏–ª–µ—Ä–∞
        if (result.dealerCheated && result.canAccuse) {
            handleAccusationMechanic(result);
        } else {
            finishRound();
        }
    }

    function nextRound() {
        if (currentRole === 'DEALER') {
            // –°–∏–º—É–ª—è—Ü–∏—è —Ä–∞—É–Ω–¥–∞ –¥–ª—è –¥–∏–ª–µ—Ä–∞
            simulateDealerRound();
        } else {
            finishRound();
        }
    }

    function simulateDealerRound() {
        const ballPosition = Math.floor(Math.random() * 3);
        const playerGuess = Math.floor(Math.random() * 3);
        const isCorrect = (playerGuess === ballPosition);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
        const roundResult = {
            round: currentRound,
            playerGuess: playerGuess,
            actualPosition: ballPosition,
            correct: isCorrect,
            dealerCheated: false
        };
        gameHistory.push(roundResult);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç
        if (isCorrect) {
            playerWins++;
            showMessage(`–ò–≥—Ä–æ–∫ —É–≥–∞–¥–∞–ª! –û–Ω –≤—ã–±—Ä–∞–ª —Å—Ç–∞–∫–∞–Ω ${playerGuess + 1}`, 'success');
        } else {
            dealerWins++;
            showMessage(`–ò–≥—Ä–æ–∫ –Ω–µ —É–≥–∞–¥–∞–ª! –û–Ω –≤—ã–±—Ä–∞–ª —Å—Ç–∞–∫–∞–Ω ${playerGuess + 1}, –∞ —à–∞—Ä–∏–∫ –≤ ${ballPosition + 1}`, 'error');
        }

        showBallPosition(ballPosition);
        updateScores();
        finishRound();
    }

    function finishRound() {
        currentRound++;
        updateRoundInfo();

        if (checkGameOver()) {
            endGame();
        } else {
            document.getElementById('nextRoundBtn').style.display = 'block';
            showMessage('–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à–µ–Ω! –ù–∞–∂–º–∏—Ç–µ "–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥"', 'info');
        }
    }

    function handleAccusationMechanic(result) {
        const mechanics = document.getElementById('specialMechanics');
        mechanics.innerHTML = `
            <h3>üé© –î–∏–ª–µ—Ä –∂—É–ª—å–Ω–∏—á–∞–µ—Ç!</h3>
            <p>${result.message}</p>
            <button class="mechanic-option" onclick="accuseDealer('HIDE_IN_SLEEVE')">üé© –°–ø—Ä—è—Ç–∞–ª –≤ —Ä—É–∫–∞–≤</button>
            <button class="mechanic-option" onclick="accuseDealer('SWAP_CUPS')">üîÑ –ü–µ—Ä–µ–ª–æ–∂–∏–ª –≤ —Å—Ç–∞–∫–∞–Ω</button>
            <button class="btn-secondary" onclick="surrenderRound()">–ü—Ä–∏–∑–Ω–∞—Ç—å –ø–æ—Ä–∞–∂–µ–Ω–∏–µ</button>
        `;
        mechanics.style.display = 'block';
    }

    async function accuseDealer(mechanic) {
        try {
            const response = await fetch(
                `${API_BASE_URL}/api/game/accuse?gameId=${currentGameId}&accusedMechanic=${mechanic}`,
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`
                    }
                }
            );

            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    playerWins++;
                    showMessage(result.message, 'success');
                } else {
                    dealerWins++;
                    showMessage(result.message, 'error');
                }
                updateScores();
                document.getElementById('specialMechanics').style.display = 'none';
                finishRound();
            }
        } catch (error) {
            showMessage('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
        }
    }

    function surrenderRound() {
        dealerWins++;
        updateScores();
        document.getElementById('specialMechanics').style.display = 'none';
        showMessage('–í—ã –ø—Ä–∏–∑–Ω–∞–ª–∏ –ø–æ—Ä–∞–∂–µ–Ω–∏–µ', 'info');
        finishRound();
    }

    function checkGameOver() {
        return playerWins >= winsToWinGame || dealerWins >= winsToWinGame || currentRound > maxRounds;
    }

    function endGame() {
        gameFinished = true;
        showFinalResults();
    }

    function showFinalResults() {
        const finalStats = document.getElementById('finalStats');
        let winner = '';

        if (playerWins > dealerWins) {
            winner = 'üéâ –ü–û–ë–ï–î–ê –ò–ì–†–û–ö–ê!';
        } else if (dealerWins > playerWins) {
            winner = 'üòî –ü–û–ë–ï–î–ê –î–ò–õ–ï–†–ê!';
        } else {
            winner = 'ü§ù –ù–ò–ß–¨–Ø!';
        }

        let statsHTML = `
            <h3>${winner}</h3>
            <p>–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—á–µ—Ç: <strong>${playerWins} - ${dealerWins}</strong></p>
            <p>–°—ã–≥—Ä–∞–Ω–æ —Ä–∞—É–Ω–¥–æ–≤: <strong>${currentRound - 1}</strong></p>
            <h4>–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—É–Ω–¥–æ–≤:</h4>
        `;

        gameHistory.forEach((round, index) => {
            statsHTML += `<p>–†–∞—É–Ω–¥ ${round.round}: `;
            statsHTML += `–ò–≥—Ä–æ–∫ –≤—ã–±—Ä–∞–ª ${round.playerGuess + 1}, `;
            statsHTML += `—à–∞—Ä–∏–∫ –≤ ${round.actualPosition + 1}, `;
            statsHTML += round.correct ? '‚úÖ –£–≥–∞–¥–∞–ª' : '‚ùå –ù–µ —É–≥–∞–¥–∞–ª';
            if (round.dealerCheated) {
                statsHTML += ', üé© –î–∏–ª–µ—Ä –∂—É–ª—å–Ω–∏—á–∞–ª';
            }
            statsHTML += `</p>`;
        });

        finalStats.innerHTML = statsHTML;
        document.getElementById('resultsTitle').textContent = `–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã (${getRoleName(currentRole)})`;
        showScreen('resultsScreen');
    }

    // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
    function highlightCup(index) {
        document.querySelectorAll('.cup').forEach((cup, i) => {
            cup.classList.toggle('selected', i === index);
        });
    }

    function showBallPosition(position) {
        document.querySelectorAll('.cup').forEach((cup, i) => {
            if (i === position) {
                cup.textContent = 'üéØ';
                cup.style.background = 'rgba(255,215,0,0.3)';
            }
        });
    }

    function enableCups() {
        document.querySelectorAll('.cup').forEach(cup => {
            cup.style.pointerEvents = 'auto';
            cup.style.opacity = '1';
        });
    }

    function disableCups() {
        document.querySelectorAll('.cup').forEach(cup => {
            cup.style.pointerEvents = 'none';
            cup.style.opacity = '0.7';
        });
    }

    function resetCups() {
        document.querySelectorAll('.cup').forEach((cup, i) => {
            cup.textContent = `ü•§ ${i + 1}`;
            cup.classList.remove('selected');
            cup.style.background = 'rgba(255,255,255,0.1)';
        });
    }

    function updateScores() {
        document.getElementById('playerScore').textContent = playerWins;
        document.getElementById('dealerScore').textContent = dealerWins;
    }

    function updateRoundInfo() {
        document.getElementById('roundNumber').textContent = currentRound;
    }

    function showMessage(message, type) {
        const gameMessage = document.getElementById('gameMessage');
        gameMessage.textContent = message;
        gameMessage.style.background = type === 'success' ? 'rgba(76, 175, 80, 0.3)' :
                                      type === 'error' ? 'rgba(244, 67, 54, 0.3)' :
                                      'rgba(0, 0, 0, 0.2)';
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–≥—Ä–∞ –≥–æ—Ç–æ–≤–∞!');
    });
</script>
</body>
</html>